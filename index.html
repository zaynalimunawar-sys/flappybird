<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravity Flip 3D - Mega Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            perspective: 1000px;
        }

        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 40px;
            box-shadow: 
                0 50px 100px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.5),
                inset 0 1px 0 rgba(255,255,255,0.9);
            overflow: hidden;
            transform-style: preserve-3d;
        }

        canvas {
            display: block;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.98) 0%, rgba(118, 75, 162, 0.98) 50%, rgba(240, 147, 251, 0.98) 100%);
            z-index: 10;
            backdrop-filter: blur(20px);
            padding: 40px;
            overflow-y: auto;
        }

        .title {
            font-size: 95px;
            font-weight: 900;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            text-shadow: 0 15px 50px rgba(0,0,0,0.5);
            letter-spacing: -4px;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
        }

        .tagline {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255,255,255,0.85);
            margin-bottom: 50px;
            text-align: center;
            line-height: 1.6;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 18px;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
            margin-bottom: 50px;
            text-align: center;
            line-height: 1.8;
            max-width: 500px;
        }

        .btn {
            padding: 20px 50px;
            font-size: 16px;
            font-weight: 800;
            color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.5),
                inset 0 1px 0 rgba(255,255,255,1);
            margin: 6px;
            letter-spacing: 1px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.6),
                inset 0 1px 0 rgba(255,255,255,1);
        }

        .btn:active {
            transform: translateY(-4px) scale(1.01);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.5);
        }

        .btn-small {
            padding: 15px 35px;
            font-size: 14px;
        }

        #hud {
            position: absolute;
            top: 25px;
            left: 25px;
            right: 25px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
        }

        .hud-box {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 18px 32px;
            border-radius: 20px;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            backdrop-filter: blur(20px);
        }

        .hud-label {
            font-size: 10px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .hud-value {
            font-size: 42px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
        }

        .controls-hint {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 16px 32px;
            border-radius: 20px;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            font-size: 15px;
            font-weight: 700;
            color: #667eea;
            display: flex;
            gap: 28px;
            backdrop-filter: blur(20px);
        }

        .hint-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .difficulty-indicator {
            position: absolute;
            top: 95px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 12px 30px;
            border-radius: 50px;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            font-size: 13px;
            font-weight: 800;
            display: none;
            z-index: 5;
            backdrop-filter: blur(20px);
            letter-spacing: 1px;
        }

        .difficulty-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .difficulty-bar {
            width: 120px;
            height: 8px;
            background: rgba(102, 126, 234, 0.15);
            border-radius: 10px;
            overflow: hidden;
            display: inline-block;
            margin-left: 12px;
            vertical-align: middle;
        }

        .difficulty-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 10px;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .instruction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 40px 60px;
            border-radius: 30px;
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            display: none;
            animation: pulse 2s ease-in-out infinite;
            z-index: 15;
            pointer-events: none;
            text-align: center;
            line-height: 1.8;
            backdrop-filter: blur(20px);
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        .stats-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 35px 45px;
            border-radius: 30px;
            margin: 20px 0;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            min-width: 400px;
            backdrop-filter: blur(20px);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            border-bottom: 2px solid rgba(102, 126, 234, 0.08);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-value {
            font-weight: 900;
            color: #1a1a2e;
        }

        .emoji {
            font-size: 70px;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out infinite;
            filter: drop-shadow(0 15px 40px rgba(0,0,0,0.4));
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-25px) scale(1.05); }
        }

        .version {
            position: absolute;
            bottom: 25px;
            right: 35px;
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.5);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .ultra-badge {
            position: absolute;
            top: 25px;
            right: 25px;
            background: linear-gradient(135deg, rgba(255,215,0,0.95) 0%, rgba(255,193,7,0.95) 100%);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 900;
            color: #1a1a2e;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(255,193,7,0.4);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }

        .music-toggle {
            position: absolute;
            bottom: 25px;
            left: 25px;
            background: rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 24px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
            z-index: 20;
        }

        .music-toggle:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.3);
        }

        .d3-badge {
            position: absolute;
            top: 95px;
            left: 25px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 900;
            color: #ffffff;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
            z-index: 20;
        }

        .shop-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            max-width: 720px;
            margin: 20px 0;
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
        }

        .ball-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 110px;
            position: relative;
        }

        .ball-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
        }

        .ball-item.selected {
            box-shadow: 0 0 0 3px #667eea, 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .ball-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ball-preview {
            font-size: 45px;
            margin-bottom: 8px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        }

        .ball-name {
            font-weight: 800;
            font-size: 12px;
            color: #667eea;
            margin-bottom: 5px;
        }

        .ball-price {
            font-weight: 700;
            font-size: 14px;
            color: #f59e0b;
        }

        .unlocked-tag {
            font-weight: 700;
            font-size: 10px;
            color: #10b981;
        }

        .coins-display {
            background: linear-gradient(135deg, rgba(255,215,0,0.95) 0%, rgba(255,193,7,0.95) 100%);
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: 900;
            color: #1a1a2e;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(255,193,7,0.4);
        }

        .button-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }

        .button-row-horizontal {
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .milestone-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            max-width: 720px;
            margin: 20px 0;
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
        }

        .milestone-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 18px 22px;
            border-radius: 20px;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.15),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            min-width: 170px;
            text-align: center;
        }

        .milestone-item.completed {
            box-shadow: 0 0 0 3px #10b981, 0 15px 40px rgba(16, 185, 129, 0.4);
        }

        .milestone-icon {
            font-size: 35px;
            margin-bottom: 8px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        }

        .milestone-title {
            font-weight: 800;
            font-size: 13px;
            color: #667eea;
            margin-bottom: 5px;
        }

        .milestone-desc {
            font-weight: 600;
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .milestone-reward {
            font-weight: 700;
            font-size: 12px;
            color: #f59e0b;
        }

        .milestone-status {
            font-weight: 700;
            font-size: 10px;
            color: #10b981;
            margin-top: 5px;
        }

        .code-input-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.95) 100%);
            padding: 30px 40px;
            border-radius: 30px;
            margin: 20px 0;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.8),
                inset 0 1px 0 rgba(255,255,255,1);
            text-align: center;
        }

        .code-input {
            padding: 15px 25px;
            font-size: 18px;
            font-weight: 700;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            width: 300px;
            font-family: 'Inter', sans-serif;
        }

        .code-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
        }

        .code-message {
            font-size: 14px;
            font-weight: 700;
            margin-top: 10px;
            min-height: 20px;
        }

        .code-message.success {
            color: #10b981;
        }

        .code-message.error {
            color: #ef4444;
        }

        .milestone-notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.6);
            z-index: 1000;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .milestone-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    

        .ball-rarity {
            font-weight: 800;
            font-size: 9px;
            margin-top: 5px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .rarity-common { color: #6b7280; }
        .rarity-uncommon { color: #10b981; }
        .rarity-rare { color: #3b82f6; }
        .rarity-epic { color: #a855f7; }
        .rarity-legendary { color: #f59e0b; }

        .ball-item.rarity-common {
            border: 2px solid #9ca3af;
        }

        .ball-item.rarity-uncommon {
            border: 2px solid #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3), 0 10px 30px rgba(0,0,0,0.15);
        }

        .ball-item.rarity-rare {
            border: 2px solid #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3), 0 10px 30px rgba(0,0,0,0.15);
        }

        .ball-item.rarity-epic {
            border: 2px solid #a855f7;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4), 0 10px 30px rgba(0,0,0,0.15);
        }

        .ball-item.rarity-legendary {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.5), 0 10px 30px rgba(0,0,0,0.15);
            animation: legendary-glow 2s ease-in-out infinite;
        }

        @keyframes legendary-glow {
            0%, 100% { box-shadow: 0 0 25px rgba(245, 158, 11, 0.5), 0 10px 30px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 0 35px rgba(245, 158, 11, 0.7), 0 10px 30px rgba(0,0,0,0.15); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="hud">
            <div class="hud-box">
                <div class="hud-label">Distance</div>
                <div class="hud-value" id="distance">0m</div>
            </div>
            <div class="controls-hint">
                <div class="hint-item">‚¨ÜÔ∏è Ceiling</div>
                <div class="hint-item">‚¨áÔ∏è Floor</div>
            </div>
            <div class="hud-box">
                <div class="hud-label">Coins</div>
                <div class="hud-value" id="coins">0</div>
            </div>
        </div>

        <div class="difficulty-indicator" id="difficulty">
            <span class="difficulty-text" id="difficultyText">EASY</span>
            <div class="difficulty-bar">
                <div class="difficulty-fill" id="difficultyFill" style="width: 10%"></div>
            </div>
        </div>

        <div class="instruction" id="instruction">
            <div style="font-size: 50px; margin-bottom: 15px;">‚¨ÜÔ∏è ‚¨áÔ∏è</div>
            <div>Tap arrows to flip gravity!</div>
        </div>

        <div class="milestone-notification" id="milestoneNotification"></div>

        <div class="music-toggle" id="musicToggle" onclick="toggleMusic()">üîá</div>
        <div class="d3-badge">3D MODE</div>

        <div id="startScreen" class="screen">
            <div class="ultra-badge">MEGA EDITION</div>
            <div class="emoji">üü¢</div>
            <div class="title">Gravity Flip 3D</div>
            <div class="tagline">Mega Edition - 15 Balls + 20 Milestones!</div>
            <div class="subtitle">
                The ultimate collection with tons of content!
            </div>
            <div class="button-row-horizontal">
                <button class="btn" onclick="startGame()">Start Game</button>
                <button class="btn btn-secondary" onclick="openShop()">üõí Shop</button>
                <button class="btn btn-secondary" onclick="openMilestones()">üèÜ Milestones</button>
                <button class="btn btn-secondary" onclick="openCodes()">üéÅ Codes</button>
            </div>
            <div class="version">v6.0 Mega Edition</div>
        </div>

        <div id="shopScreen" class="screen" style="display: none;">
            <div class="title" style="font-size: 50px; margin-bottom: 15px;">üõí Ball Shop</div>
            <div class="coins-display">üí∞ <span id="shopCoins">0</span> Coins</div>
            <div class="shop-container" id="shopContainer"></div>
            <button class="btn" onclick="closeShop()">Back to Menu</button>
        </div>

        <div id="milestonesScreen" class="screen" style="display: none;">
            <div class="title" style="font-size: 50px; margin-bottom: 15px;">üèÜ Milestones</div>
            <div class="milestone-container" id="milestoneContainer"></div>
            <button class="btn" onclick="closeMilestones()">Back to Menu</button>
        </div>

        <div id="codesScreen" class="screen" style="display: none;">
            <div class="title" style="font-size: 50px; margin-bottom: 15px;">üéÅ Redeem Code</div>
            <div class="code-input-container">
                <input type="text" class="code-input" id="codeInput" placeholder="ENTER CODE" maxlength="20">
                <br>
                <button class="btn btn-small" onclick="redeemCode()">Redeem</button>
                <div class="code-message" id="codeMessage"></div>
            </div>
            <div style="background: rgba(255,255,255,0.98); padding: 20px; border-radius: 20px; max-width: 500px; margin: 20px 0;">
                <div style="font-size: 14px; font-weight: 700; color: #667eea; margin-bottom: 10px;">üí° SECRET CODES</div>
                <div style="font-size: 12px; color: #6b7280; line-height: 1.8;">
                    Find secret codes to unlock exclusive legendary balls!<br>
                    Codes are hidden... keep exploring! üîç<br>
                    Hint: They might be related to special things... ü§î
                </div>
            </div>
            <button class="btn" onclick="closeCodes()">Back to Menu</button>
        </div>

        <div id="gameOverScreen" class="screen" style="display: none;">
            <div class="emoji">üí•</div>
            <div class="title" style="font-size: 60px; margin-bottom: 15px;">Game Over!</div>
            <div class="stats-container">
                <div class="stat-row">
                    <span class="stat-label">Distance</span>
                    <span class="stat-value" id="finalDistance">0m</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Coins Earned</span>
                    <span class="stat-value" id="coinsEarned">+0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Coins</span>
                    <span class="stat-value" id="totalCoins">0</span>
                </div>
            </div>
            <div id="milestoneUnlockMessage" style="display: none; margin: 15px 0;"></div>
            <div class="button-row">
                <button class="btn" onclick="startGame()">Play Again</button>
                <button class="btn btn-secondary" onclick="backToMenu()">Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameStarted = false;
        let gameOver = false;
        let gameReady = false;
        let distance = 0;
        let bestDistance = parseInt(localStorage.getItem('gravityFlipBest')) || 0;
        let coins = parseInt(localStorage.getItem('gravityFlipCoins')) || 0;
        let earnedCoins = 0;
        let speed = 5;
        let frameCount = 0;
        let difficulty = 'EASY';
        let spawnRate = 95;

        const ballSkins = {
            classic: { emoji: 'üü¢', name: 'Classic', price: 0, unlocked: true, rarity: 'common', 
                colors: ['#d1fae5', '#6ee7b7', '#34d399', '#10b981', '#047857'] },
            fire: { emoji: 'üî•', name: 'Fire', price: 50, unlocked: false, rarity: 'common',
                colors: ['#fef3c7', '#fcd34d', '#f59e0b', '#dc2626', '#7f1d1d'] },
            ice: { emoji: '‚ùÑÔ∏è', name: 'Ice', price: 50, unlocked: false, rarity: 'common',
                colors: ['#e0f2fe', '#7dd3fc', '#0ea5e9', '#0369a1', '#0c4a6e'] },
            electric: { emoji: '‚ö°', name: 'Electric', price: 100, unlocked: false, rarity: 'uncommon',
                colors: ['#fef9c3', '#fde047', '#eab308', '#a16207', '#713f12'] },
            rainbow: { emoji: 'üåà', name: 'Rainbow', price: 150, unlocked: false, rarity: 'rare',
                colors: ['#fecaca', '#fde047', '#86efac', '#7dd3fc', '#c4b5fd'] },
            galaxy: { emoji: 'üåå', name: 'Galaxy', price: 200, unlocked: false, rarity: 'rare',
                colors: ['#e9d5ff', '#c084fc', '#9333ea', '#6b21a8', '#4c1d95'] },
            gold: { emoji: 'üíé', name: 'Diamond', price: 300, unlocked: false, rarity: 'epic',
                colors: ['#fef9c3', '#fde047', '#facc15', '#eab308', '#ca8a04'] },
            dark: { emoji: 'üñ§', name: 'Shadow', price: 250, unlocked: false, rarity: 'epic',
                colors: ['#6b7280', '#4b5563', '#374151', '#1f2937', '#111827'] },
            toxic: { emoji: '‚ò¢Ô∏è', name: 'Toxic', price: 175, unlocked: false, rarity: 'rare',
                colors: ['#d1fae5', '#86efac', '#22c55e', '#15803d', '#14532d'] },
            ocean: { emoji: 'üåä', name: 'Ocean', price: 125, unlocked: false, rarity: 'uncommon',
                colors: ['#cffafe', '#67e8f9', '#06b6d4', '#0e7490', '#164e63'] },
            sunset: { emoji: 'üåÖ', name: 'Sunset', price: 225, unlocked: false, rarity: 'epic',
                colors: ['#fed7aa', '#fb923c', '#f97316', '#ea580c', '#9a3412'] },
            mystic: { emoji: 'üîÆ', name: 'Mystic', price: 350, unlocked: false, rarity: 'legendary',
                colors: ['#fae8ff', '#f0abfc', '#d946ef', '#a21caf', '#701a75'] },
            admin: { emoji: 'üëë', name: 'ADMIN', price: 0, unlocked: false, rarity: 'legendary', secret: true,
                colors: ['#fef9c3', '#fde047', '#f59e0b', '#dc2626', '#9333ea'] },
            mega: { emoji: 'üöÄ', name: 'MEGA', price: 0, unlocked: false, rarity: 'legendary', secret: true,
                colors: ['#dbeafe', '#60a5fa', '#3b82f6', '#1d4ed8', '#1e3a8a'] },
            epic: { emoji: '‚≠ê', name: 'EPIC', price: 0, unlocked: false, rarity: 'legendary', secret: true,
                colors: ['#fff7ed', '#fed7aa', '#fdba74', '#fb923c', '#ea580c'] }
        };

        const milestones = [
            { id: 'first_run', icon: 'üéÆ', title: 'First Steps', desc: 'Reach 10m', target: 10, reward: 10, completed: false },
            { id: 'beginner', icon: 'üåü', title: 'Beginner', desc: 'Reach 25m', target: 25, reward: 25, completed: false },
            { id: 'skilled', icon: 'üí´', title: 'Getting Good', desc: 'Reach 50m', target: 50, reward: 50, completed: false },
            { id: 'adept', icon: '‚ú®', title: 'Adept', desc: 'Reach 75m', target: 75, reward: 60, completed: false },
            { id: 'expert', icon: 'üî•', title: 'Expert', desc: 'Reach 100m', target: 100, reward: 100, completed: false },
            { id: 'pro', icon: 'üéØ', title: 'Pro Player', desc: 'Reach 150m', target: 150, reward: 125, completed: false },
            { id: 'master', icon: 'üëë', title: 'Master', desc: 'Reach 200m', target: 200, reward: 200, completed: false },
            { id: 'elite', icon: 'üí™', title: 'Elite', desc: 'Reach 300m', target: 300, reward: 250, completed: false },
            { id: 'champion', icon: 'üèÖ', title: 'Champion', desc: 'Reach 400m', target: 400, reward: 300, completed: false },
            { id: 'legend', icon: 'üíé', title: 'Legend', desc: 'Reach 500m', target: 500, reward: 500, completed: false },
            { id: 'immortal', icon: 'üåü', title: 'Immortal', desc: 'Reach 750m', target: 750, reward: 750, completed: false },
            { id: 'godlike', icon: '‚ö°', title: 'Godlike', desc: 'Reach 1000m', target: 1000, reward: 1000, completed: false },
            { id: 'coin_starter', icon: 'üí∞', title: 'Coin Starter', desc: 'Earn 50 coins', target: 50, type: 'coins', reward: 25, completed: false },
            { id: 'coin_collector', icon: 'üí∏', title: 'Coin Collector', desc: 'Earn 100 coins', target: 100, type: 'coins', reward: 50, completed: false },
            { id: 'wealthy', icon: 'üíµ', title: 'Wealthy', desc: 'Earn 250 coins', target: 250, type: 'coins', reward: 75, completed: false },
            { id: 'rich', icon: 'ü§ë', title: 'Rich!', desc: 'Earn 500 coins', target: 500, type: 'coins', reward: 100, completed: false },
            { id: 'millionaire', icon: 'üíé', title: 'Millionaire', desc: 'Earn 1000 coins', target: 1000, type: 'coins', reward: 250, completed: false },
            { id: 'ball_starter', icon: 'üé®', title: 'Ball Starter', desc: 'Unlock 3 balls', target: 3, type: 'balls', reward: 50, completed: false },
            { id: 'ball_collector', icon: 'üéØ', title: 'Ball Collector', desc: 'Unlock 7 balls', target: 7, type: 'balls', reward: 100, completed: false },
            { id: 'completionist', icon: 'üèÜ', title: 'Completionist', desc: 'Unlock all balls', target: 15, type: 'balls', reward: 500, completed: false }
        ];

        const savedMilestones = JSON.parse(localStorage.getItem('gravityFlipMilestones')) || {};
        milestones.forEach(m => {
            if (savedMilestones[m.id]) m.completed = savedMilestones[m.id];
        });

        let currentSkin = localStorage.getItem('gravityFlipSkin') || 'classic';

        const unlockedSkins = JSON.parse(localStorage.getItem('gravityFlipUnlocked')) || ['classic'];
        unlockedSkins.forEach(skin => {
            if (ballSkins[skin]) ballSkins[skin].unlocked = true;
        });

        const totalCoinsEarned = parseInt(localStorage.getItem('gravityFlipTotalCoins')) || 0;

        const player = {
            x: 150,
            y: canvas.height - 50,
            z: 0,
            radius: 35,
            onCeiling: false,
            transitioning: false,
            transitionProgress: 0,
            transitionSpeed: 0.12,
            rotation: 0,
            targetRotation: 0,
            pulsePhase: 0,
            glowIntensity: 0
        };

        let spikes = [];
        let particles = [];
        let trailParticles = [];
        let ambientParticles = [];
        let shineParticles = [];
        let gridLines = [];

        for (let i = 0; i < 20; i++) {
            gridLines.push({ z: i * 100, opacity: 0.1 });
        }

        for (let i = 0; i < 80; i++) {
            ambientParticles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                z: Math.random() * 500,
                radius: Math.random() * 3 + 1,
                speed: Math.random() * 0.15 + 0.03,
                opacity: Math.random() * 0.2 + 0.05,
                twinkleSpeed: Math.random() * 0.01 + 0.005,
                twinklePhase: Math.random() * Math.PI * 2
            });
        }

        let audioContext;
        let musicGain, bassGain, melodyGain, padGain;
        let musicPlaying = false;
        let musicInterval;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                musicGain = audioContext.createGain();
                musicGain.connect(audioContext.destination);
                musicGain.gain.value = 0.2;
                bassGain = audioContext.createGain();
                bassGain.gain.value = 0.25;
                bassGain.connect(musicGain);
                melodyGain = audioContext.createGain();
                melodyGain.gain.value = 0.2;
                melodyGain.connect(musicGain);
                padGain = audioContext.createGain();
                padGain.gain.value = 0.15;
                padGain.connect(musicGain);
            }
        }

        function playSound(freq, duration = 0.1, type = 'sine', volume = 0.06) {
            initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(volume, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + duration);
        }

        function playDeathSound() {
            initAudio();
            playSound(800, 0.15, 'sawtooth', 0.15);
            setTimeout(() => playSound(600, 0.15, 'sawtooth', 0.15), 50);
            setTimeout(() => playSound(400, 0.2, 'sawtooth', 0.15), 100);
            setTimeout(() => playSound(200, 0.3, 'sawtooth', 0.15), 150);
            setTimeout(() => playSound(100, 0.4, 'triangle', 0.12), 200);
        }

        function playNote(freq, startTime, duration, gainNode, type = 'sine') {
            const osc = audioContext.createOscillator();
            const noteGain = audioContext.createGain();
            osc.connect(noteGain);
            noteGain.connect(gainNode);
            osc.frequency.value = freq;
            osc.type = type;
            noteGain.gain.setValueAtTime(0, startTime);
            noteGain.gain.linearRampToValueAtTime(1, startTime + 0.05);
            noteGain.gain.setValueAtTime(1, startTime + duration - 0.05);
            noteGain.gain.linearRampToValueAtTime(0, startTime + duration);
            osc.start(startTime);
            osc.stop(startTime + duration);
            return osc;
        }

        function startBackgroundMusic() {
            if (musicPlaying) return;
            initAudio();
            musicPlaying = true;

            const scale = {
                C4: 261.63, D4: 293.66, E4: 329.63, G4: 392.00, A4: 440.00,
                C5: 523.25, D5: 587.33, E5: 659.25, G5: 783.99
            };

            function playMusicLoop() {
                if (!musicPlaying) return;
                const now = audioContext.currentTime;
                const beatLength = 0.5;
                playNote(scale.C4, now, beatLength * 2, bassGain, 'triangle');
                playNote(scale.G4, now + beatLength * 2, beatLength * 2, bassGain, 'triangle');
                playNote(scale.A4, now + beatLength * 4, beatLength * 2, bassGain, 'triangle');
                playNote(scale.G4, now + beatLength * 6, beatLength * 2, bassGain, 'triangle');
                playNote(scale.C5, now + beatLength * 0, beatLength * 0.8, melodyGain, 'sine');
                playNote(scale.E5, now + beatLength * 1, beatLength * 0.8, melodyGain, 'sine');
                playNote(scale.G5, now + beatLength * 2, beatLength * 0.8, melodyGain, 'sine');
                playNote(scale.E5, now + beatLength * 3, beatLength * 0.8, melodyGain, 'sine');
                playNote(scale.D5, now + beatLength * 4, beatLength * 1.5, melodyGain, 'sine');
                playNote(scale.C5, now + beatLength * 6, beatLength * 1.5, melodyGain, 'sine');
                playNote(scale.C4, now, beatLength * 4, padGain, 'sine');
                playNote(scale.E4, now, beatLength * 4, padGain, 'sine');
                playNote(scale.G4, now, beatLength * 4, padGain, 'sine');
                playNote(scale.D4, now + beatLength * 4, beatLength * 4, padGain, 'sine');
                playNote(scale.A4, now + beatLength * 4, beatLength * 4, padGain, 'sine');
                musicInterval = setTimeout(playMusicLoop, beatLength * 8 * 1000);
            }
            playMusicLoop();
        }

        function stopBackgroundMusic() {
            musicPlaying = false;
            if (musicInterval) {
                clearTimeout(musicInterval);
                musicInterval = null;
            }
        }

        function toggleMusic() {
            if (musicPlaying) {
                stopBackgroundMusic();
                document.getElementById('musicToggle').textContent = 'üîá';
            } else {
                startBackgroundMusic();
                document.getElementById('musicToggle').textContent = 'üîä';
            }
        }

        function showMilestoneNotification(milestone) {
            const notif = document.getElementById('milestoneNotification');
            notif.textContent = `üèÜ ${milestone.title} Complete! +${milestone.reward} coins`;
            notif.classList.add('show');
            playSound(1200, 0.3);
            setTimeout(() => playSound(1500, 0.3), 100);
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        function checkMilestones() {
            let newUnlocks = [];
            const unlockedCount = Object.keys(ballSkins).filter(k => ballSkins[k].unlocked).length;
            const totalCoins = parseInt(localStorage.getItem('gravityFlipTotalCoins')) || 0;

            milestones.forEach(m => {
                if (!m.completed) {
                    let achieved = false;
                    if (m.type === 'coins') {
                        achieved = totalCoins >= m.target;
                    } else if (m.type === 'balls') {
                        achieved = unlockedCount >= m.target;
                    } else {
                        achieved = bestDistance >= m.target;
                    }

                    if (achieved) {
                        m.completed = true;
                        coins += m.reward;
                        newUnlocks.push(m);
                        showMilestoneNotification(m);
                    }
                }
            });

            if (newUnlocks.length > 0) {
                const saved = {};
                milestones.forEach(m => { saved[m.id] = m.completed; });
                localStorage.setItem('gravityFlipMilestones', JSON.stringify(saved));
                localStorage.setItem('gravityFlipCoins', coins);
            }

            return newUnlocks;
        }

        function openShop() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('shopScreen').style.display = 'flex';
            document.getElementById('shopCoins').textContent = coins;
            renderShop();
        }

        function closeShop() {
            document.getElementById('shopScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function openMilestones() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('milestonesScreen').style.display = 'flex';
            renderMilestones();
        }

        function closeMilestones() {
            document.getElementById('milestonesScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function openCodes() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('codesScreen').style.display = 'flex';
            document.getElementById('codeInput').value = '';
            document.getElementById('codeMessage').textContent = '';
        }

        function closeCodes() {
            document.getElementById('codesScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function redeemCode() {
            const input = document.getElementById('codeInput');
            const message = document.getElementById('codeMessage');
            const code = input.value.toUpperCase().replace(/\s/g, '');

            if (!code) {
                message.textContent = '‚ùå Please enter a code';
                message.className = 'code-message error';
                return;
            }

            const codes = {
                'ADMINBALL': 'admin',
                'MEGABALL': 'mega',
                'EPICBALL': 'epic'
            };

            if (codes[code]) {
                const skinKey = codes[code];
                if (ballSkins[skinKey].unlocked) {
                    message.textContent = '‚ö†Ô∏è Already redeemed!';
                    message.className = 'code-message error';
                    playSound(200, 0.1);
                } else {
                    ballSkins[skinKey].unlocked = true;
                    currentSkin = skinKey;
                    localStorage.setItem('gravityFlipSkin', skinKey);
                    const unlocked = Object.keys(ballSkins).filter(k => ballSkins[k].unlocked);
                    localStorage.setItem('gravityFlipUnlocked', JSON.stringify(unlocked));
                    message.textContent = `üéâ ${ballSkins[skinKey].name} BALL UNLOCKED!`;
                    message.className = 'code-message success';
                    playSound(1500, 0.5);
                    setTimeout(() => playSound(1800, 0.5), 150);
                    checkMilestones();
                }
            } else {
                message.textContent = '‚ùå Invalid code';
                message.className = 'code-message error';
                playSound(200, 0.1);
            }

            input.value = '';
        }

        function renderMilestones() {
            const container = document.getElementById('milestoneContainer');
            container.innerHTML = '';

            const unlockedCount = Object.keys(ballSkins).filter(k => ballSkins[k].unlocked).length;
            const totalCoins = parseInt(localStorage.getItem('gravityFlipTotalCoins')) || 0;

            milestones.forEach(m => {
                const item = document.createElement('div');
                item.className = 'milestone-item' + (m.completed ? ' completed' : '');

                let progress = 0;
                if (m.type === 'coins') {
                    progress = Math.min(totalCoins, m.target);
                } else if (m.type === 'balls') {
                    progress = Math.min(unlockedCount, m.target);
                } else {
                    progress = Math.min(bestDistance, m.target);
                }

                item.innerHTML = `
                    <div class="milestone-icon">${m.icon}</div>
                    <div class="milestone-title">${m.title}</div>
                    <div class="milestone-desc">${m.desc}</div>
                    <div class="milestone-reward">üéÅ ${m.reward} coins</div>
                    ${m.completed ? 
                        '<div class="milestone-status">‚úì COMPLETED</div>' : 
                        `<div class="milestone-desc">${progress}/${m.target}</div>`}
                `;

                container.appendChild(item);
            });
        }

        function renderShop() {
            const container = document.getElementById('shopContainer');
            container.innerHTML = '';

            Object.entries(ballSkins).forEach(([key, skin]) => {
                if (skin.secret && !skin.unlocked) return;

                const item = document.createElement('div');
                item.className = 'ball-item' + (key === currentSkin ? ' selected' : '') + 
                                 (!skin.unlocked ? ' locked' : '');

                item.innerHTML = `
                    <div class="ball-preview">${skin.emoji}</div>
                    <div class="ball-name">${skin.name}</div>
                    ${skin.unlocked ? 
                        (key === currentSkin ? '<div class="unlocked-tag">‚úì EQUIPPED</div>' : '<div class="unlocked-tag">OWNED</div>') : 
                        `<div class="ball-price">üí∞ ${skin.price}</div>`}
                `;

                item.onclick = () => {
                    if (skin.unlocked) {
                        currentSkin = key;
                        localStorage.setItem('gravityFlipSkin', key);
                        renderShop();
                        playSound(600, 0.08);
                    } else if (coins >= skin.price) {
                        coins -= skin.price;
                        skin.unlocked = true;
                        currentSkin = key;
                        localStorage.setItem('gravityFlipCoins', coins);
                        localStorage.setItem('gravityFlipSkin', key);
                        const unlocked = Object.keys(ballSkins).filter(k => ballSkins[k].unlocked);
                        localStorage.setItem('gravityFlipUnlocked', JSON.stringify(unlocked));
                        document.getElementById('shopCoins').textContent = coins;
                        renderShop();
                        playSound(800, 0.2);
                        checkMilestones();
                    } else {
                        playSound(200, 0.1);
                    }
                };

                container.appendChild(item);
            });
        }

        let touchStartY = 0, touchStartX = 0;

        function updateDifficulty() {
            if (distance < 50) {
                difficulty = 'EASY';
                speed = 5 + distance * 0.04;
                spawnRate = 95;
                document.getElementById('difficultyFill').style.width = (distance / 50 * 20) + '%';
            } else if (distance < 120) {
                difficulty = 'MEDIUM';
                speed = 5 + distance * 0.06;
                spawnRate = 80;
                document.getElementById('difficultyFill').style.width = (20 + (distance - 50) / 70 * 20) + '%';
            } else if (distance < 200) {
                difficulty = 'HARD';
                speed = 5 + distance * 0.08;
                spawnRate = 68;
                document.getElementById('difficultyFill').style.width = (40 + (distance - 120) / 80 * 20) + '%';
            } else if (distance < 300) {
                difficulty = 'EXPERT';
                speed = 5 + distance * 0.10;
                spawnRate = 58;
                document.getElementById('difficultyFill').style.width = (60 + (distance - 200) / 100 * 20) + '%';
            } else {
                difficulty = 'MASTER';
                speed = 5 + distance * 0.12;
                spawnRate = 50;
                document.getElementById('difficultyFill').style.width = (80 + Math.min((distance - 300) / 200 * 20, 20)) + '%';
            }
            document.getElementById('difficultyText').textContent = difficulty;
        }

        function get3DScale(z) {
            const perspective = 400;
            const scale = perspective / (perspective + z);
            return Math.max(0.1, Math.min(scale, 3));
        }

        function get3DPosition(x, y, z) {
            const scale = get3DScale(z);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            return {
                x: centerX + (x - centerX) * scale,
                y: centerY + (y - centerY) * scale,
                scale: scale
            };
        }

        function flipToCeiling() {
            if (!player.transitioning && !player.onCeiling) {
                player.transitioning = true;
                player.onCeiling = true;
                player.transitionProgress = 0;
                player.targetRotation = player.rotation + Math.PI;
                player.glowIntensity = 1;
                playSound(950, 0.08);
                const colors = ballSkins[currentSkin].colors;
                for (let i = 0; i < 25; i++) {
                    particles.push({
                        x: player.x, y: player.y, z: player.z + (Math.random() - 0.5) * 100,
                        vx: (Math.random() - 0.5) * 10, vy: Math.random() * 6 + 3, vz: (Math.random() - 0.5) * 5,
                        life: 35, size: Math.random() * 5 + 2,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        rotation: Math.random() * Math.PI * 2, rotationSpeed: (Math.random() - 0.5) * 0.2
                    });
                }
                for (let i = 0; i < 10; i++) {
                    shineParticles.push({
                        x: player.x, y: player.y, z: player.z,
                        angle: Math.random() * Math.PI * 2, speed: Math.random() * 3 + 2,
                        life: 20, size: Math.random() * 3 + 1
                    });
                }
            }
        }

        function flipToFloor() {
            if (!player.transitioning && player.onCeiling) {
                player.transitioning = true;
                player.onCeiling = false;
                player.transitionProgress = 0;
                player.targetRotation = player.rotation + Math.PI;
                player.glowIntensity = 1;
                playSound(750, 0.08);
                const colors = ballSkins[currentSkin].colors;
                for (let i = 0; i < 25; i++) {
                    particles.push({
                        x: player.x, y: player.y, z: player.z + (Math.random() - 0.5) * 100,
                        vx: (Math.random() - 0.5) * 10, vy: Math.random() * -6 - 3, vz: (Math.random() - 0.5) * 5,
                        life: 35, size: Math.random() * 5 + 2,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        rotation: Math.random() * Math.PI * 2, rotationSpeed: (Math.random() - 0.5) * 0.2
                    });
                }
                for (let i = 0; i < 10; i++) {
                    shineParticles.push({
                        x: player.x, y: player.y, z: player.z,
                        angle: Math.random() * Math.PI * 2, speed: Math.random() * 3 + 2,
                        life: 20, size: Math.random() * 3 + 1
                    });
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            if ((e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W')) {
                e.preventDefault();
                if (gameReady && !gameStarted) {
                    document.getElementById('instruction').style.display = 'none';
                    gameReady = false;
                    gameStarted = true;
                    document.getElementById('difficulty').style.display = 'block';
                    gameLoop();
                }
                if (gameStarted && !gameOver) flipToCeiling();
            }
            if ((e.key === 'ArrowDown' || e.key === 's' || e.key === 'S')) {
                e.preventDefault();
                if (gameReady && !gameStarted) {
                    document.getElementById('instruction').style.display = 'none';
                    gameReady = false;
                    gameStarted = true;
                    document.getElementById('difficulty').style.display = 'block';
                    gameLoop();
                }
                if (gameStarted && !gameOver) flipToFloor();
            }
            if (e.key === 'Enter' && document.getElementById('codesScreen').style.display === 'flex') {
                redeemCode();
            }
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const touchEndY = e.changedTouches[0].clientY;
            const deltaY = touchStartY - touchEndY;
            const deltaX = Math.abs(touchStartX - e.changedTouches[0].clientX);
            if (Math.abs(deltaY) > 30 && Math.abs(deltaY) > deltaX) {
                if (gameReady && !gameStarted) {
                    document.getElementById('instruction').style.display = 'none';
                    gameReady = false;
                    gameStarted = true;
                    document.getElementById('difficulty').style.display = 'block';
                    gameLoop();
                }
                if (gameStarted && !gameOver) {
                    if (deltaY > 0) flipToCeiling();
                    else flipToFloor();
                }
            }
        });

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const clickY = e.clientY - rect.top;
            if (gameReady && !gameStarted) {
                document.getElementById('instruction').style.display = 'none';
                gameReady = false;
                gameStarted = true;
                document.getElementById('difficulty').style.display = 'block';
                gameLoop();
                return;
            }
            if (gameStarted && !gameOver) {
                if (clickY < canvas.height / 2) flipToCeiling();
                else flipToFloor();
            }
        });

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('shopScreen').style.display = 'none';
            document.getElementById('milestonesScreen').style.display = 'none';
            document.getElementById('codesScreen').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('instruction').style.display = 'block';
            document.getElementById('coins').textContent = coins;
            gameReady = true;
            gameStarted = false;
            gameOver = false;
            distance = 0;
            earnedCoins = 0;
            speed = 5;
            frameCount = 0;
            difficulty = 'EASY';
            spawnRate = 95;
            player.y = canvas.height - 50;
            player.z = 0;
            player.onCeiling = false;
            player.transitioning = false;
            player.transitionProgress = 0;
            player.rotation = 0;
            player.targetRotation = 0;
            player.pulsePhase = 0;
            player.glowIntensity = 0;
            spikes = [];
            particles = [];
            trailParticles = [];
            shineParticles = [];
            document.getElementById('distance').textContent = distance + 'm';
            updateDifficulty();
            draw();
        }

        function backToMenu() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            stopBackgroundMusic();
            document.getElementById('musicToggle').textContent = 'üîá';
        }

        function spawnSpike() {
            const fromCeiling = Math.random() > 0.5;
            const width = 50 + Math.random() * 35;
            const height = 100 + Math.random() * 90;
            spikes.push({
                x: canvas.width - 50,
                y: fromCeiling ? 0 : canvas.height - height,
                z: 0,
                width: width,
                height: height,
                fromCeiling: fromCeiling,
                pulsePhase: Math.random() * Math.PI * 2,
                glowPhase: Math.random() * Math.PI * 2
            });
        }

        function update() {
            if (!gameStarted || gameOver || gameReady) return;
            frameCount++;
            distance = Math.floor(frameCount / 10);
            earnedCoins = Math.floor(distance / 5);
            document.getElementById('distance').textContent = distance + 'm';
            document.getElementById('coins').textContent = (coins + earnedCoins);
            updateDifficulty();
            player.pulsePhase += 0.06;
            player.glowIntensity *= 0.92;

            gridLines.forEach(line => {
                line.z -= speed * 2;
                if (line.z < -100) line.z += 2000;
            });

            ambientParticles.forEach(p => {
                p.z -= speed * 0.5;
                if (p.z < -100) {
                    p.z = 500;
                    p.x = Math.random() * canvas.width;
                    p.y = Math.random() * canvas.height;
                }
                p.twinklePhase += p.twinkleSpeed;
                p.currentOpacity = p.opacity * (0.5 + Math.sin(p.twinklePhase) * 0.5);
            });

            if (frameCount % 2 === 0) {
                trailParticles.push({
                    x: player.x, y: player.y, z: player.z,
                    life: 22, radius: player.radius * 0.75, rotation: player.rotation
                });
            }

            if (player.transitioning) {
                player.transitionProgress += player.transitionSpeed;
                if (player.transitionProgress >= 1) {
                    player.transitionProgress = 1;
                    player.transitioning = false;
                    player.rotation = player.targetRotation;
                }
                const startY = player.onCeiling ? canvas.height - 50 : 50;
                const endY = player.onCeiling ? 50 : canvas.height - 50;
                player.y = startY + (endY - startY) * easeInOutCubic(player.transitionProgress);
                player.rotation = player.rotation + (player.targetRotation - player.rotation) * 0.18;
            }

            if (frameCount % spawnRate === 0) spawnSpike();

            spikes.forEach((spike, index) => {
                spike.x -= speed;
                spike.pulsePhase += 0.04;
                spike.glowPhase += 0.06;

                const playerLeft = player.x - player.radius * 0.65;
                const playerRight = player.x + player.radius * 0.65;
                const playerTop = player.y - player.radius * 0.65;
                const playerBottom = player.y + player.radius * 0.65;

                const spikeLeft = spike.x;
                const spikeRight = spike.x + spike.width;
                const spikeTop = spike.y;
                const spikeBottom = spike.y + spike.height;

                if (playerRight > spikeLeft + 15 && 
                    playerLeft < spikeRight - 15 &&
                    playerBottom > spikeTop + 15 && 
                    playerTop < spikeBottom - 15) {
                    endGame();
                }

                if (spike.x + spike.width < -50) spikes.splice(index, 1);
            });

            particles.forEach((p, index) => {
                p.x += p.vx;
                p.y += p.vy;
                p.z += p.vz;
                p.vy += 0.15;
                p.rotation += p.rotationSpeed;
                p.life--;
                if (p.life <= 0) particles.splice(index, 1);
            });

            shineParticles.forEach((p, index) => {
                p.x += Math.cos(p.angle) * p.speed;
                p.y += Math.sin(p.angle) * p.speed;
                p.life--;
                if (p.life <= 0) shineParticles.splice(index, 1);
            });

            trailParticles.forEach((p, index) => {
                p.z -= speed;
                p.life--;
                if (p.life <= 0 || p.z < -300) trailParticles.splice(index, 1);
            });
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        function draw() {
            const bgGradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width);
            bgGradient.addColorStop(0, '#f5f7ff');
            bgGradient.addColorStop(0.5, '#e8eef9');
            bgGradient.addColorStop(1, '#d8def5');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = 'rgba(102, 126, 234, 0.15)';
            ctx.lineWidth = 1;
            gridLines.forEach(line => {
                const scale = get3DScale(line.z);
                if (scale > 0.1) {
                    ctx.globalAlpha = scale * 0.3;
                    const y = canvas.height / 2;
                    const height = 200 * scale;
                    ctx.beginPath();
                    ctx.moveTo(0, y - height);
                    ctx.lineTo(canvas.width, y - height);
                    ctx.moveTo(0, y + height);
                    ctx.lineTo(canvas.width, y + height);
                    ctx.stroke();
                }
            });
            ctx.globalAlpha = 1;

            ambientParticles.sort((a, b) => b.z - a.z).forEach(p => {
                const pos = get3DPosition(p.x, p.y, p.z);
                if (pos.scale > 0.1) {
                    ctx.globalAlpha = p.currentOpacity * pos.scale;
                    const size = p.radius * pos.scale * 2;
                    const gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, size);
                    gradient.addColorStop(0, 'rgba(102, 126, 234, 0.6)');
                    gradient.addColorStop(1, 'rgba(102, 126, 234, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            ctx.globalAlpha = 1;

            const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            borderGradient.addColorStop(0, '#c8cfe8');
            borderGradient.addColorStop(0.5, '#b4bfed');
            borderGradient.addColorStop(1, '#c8cfe8');
            ctx.fillStyle = borderGradient;
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(102, 126, 234, 0.3)';
            ctx.fillRect(0, 0, canvas.width, 35);
            ctx.fillRect(0, canvas.height - 35, canvas.width, 35);
            ctx.shadowBlur = 0;

            spikes.forEach(spike => {
                const pulse = Math.sin(spike.pulsePhase) * 2;
                const glow = Math.sin(spike.glowPhase) * 0.3 + 0.7;

                ctx.save();
                ctx.shadowBlur = 30 + pulse * 5;
                ctx.shadowColor = `rgba(220, 38, 38, ${0.6 * glow})`;

                const gradient = ctx.createLinearGradient(spike.x, spike.y, spike.x + spike.width/2, spike.y + spike.height);
                gradient.addColorStop(0, '#fecaca');
                gradient.addColorStop(0.2, '#fca5a5');
                gradient.addColorStop(0.5, '#f87171');
                gradient.addColorStop(0.8, '#ef4444');
                gradient.addColorStop(1, '#b91c1c');
                ctx.fillStyle = gradient;

                ctx.beginPath();
                if (spike.fromCeiling) {
                    ctx.moveTo(spike.x, spike.y);
                    ctx.lineTo(spike.x + spike.width / 2, spike.y + spike.height);
                    ctx.lineTo(spike.x + spike.width, spike.y);
                } else {
                    ctx.moveTo(spike.x, spike.y + spike.height);
                    ctx.lineTo(spike.x + spike.width / 2, spike.y);
                    ctx.lineTo(spike.x + spike.width, spike.y + spike.height);
                }
                ctx.closePath();
                ctx.fill();
                ctx.shadowBlur = 0;

                ctx.globalAlpha = 0.6 * glow;
                const highlightGradient = ctx.createLinearGradient(
                    spike.x + spike.width * 0.3,
                    spike.fromCeiling ? spike.y : spike.y + spike.height,
                    spike.x + spike.width * 0.4,
                    spike.fromCeiling ? spike.y + spike.height * 0.4 : spike.y + spike.height * 0.6
                );
                highlightGradient.addColorStop(0, '#ffffff');
                highlightGradient.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.fillStyle = highlightGradient;
                ctx.beginPath();
                if (spike.fromCeiling) {
                    ctx.moveTo(spike.x + spike.width * 0.3, spike.y);
                    ctx.lineTo(spike.x + spike.width * 0.4, spike.y + spike.height * 0.4);
                    ctx.lineTo(spike.x + spike.width * 0.5, spike.y + spike.height * 0.3);
                    ctx.lineTo(spike.x + spike.width * 0.4, spike.y);
                } else {
                    ctx.moveTo(spike.x + spike.width * 0.3, spike.y + spike.height);
                    ctx.lineTo(spike.x + spike.width * 0.4, spike.y + spike.height * 0.6);
                    ctx.lineTo(spike.x + spike.width * 0.5, spike.y + spike.height * 0.7);
                    ctx.lineTo(spike.x + spike.width * 0.4, spike.y + spike.height);
                }
                ctx.closePath();
                ctx.fill();
                ctx.globalAlpha = 1;

                ctx.strokeStyle = '#7f1d1d';
                ctx.lineWidth = 2.5;
                ctx.lineJoin = 'miter';
                ctx.beginPath();
                if (spike.fromCeiling) {
                    ctx.moveTo(spike.x, spike.y);
                    ctx.lineTo(spike.x + spike.width / 2, spike.y + spike.height);
                    ctx.lineTo(spike.x + spike.width, spike.y);
                } else {
                    ctx.moveTo(spike.x, spike.y + spike.height);
                    ctx.lineTo(spike.x + spike.width / 2, spike.y);
                    ctx.lineTo(spike.x + spike.width, spike.y + spike.height);
                }
                ctx.closePath();
                ctx.stroke();
                ctx.restore();
            });

            trailParticles.sort((a, b) => b.z - a.z).forEach(p => {
                const pos = get3DPosition(p.x, p.y, p.z);
                if (pos.scale > 0.1) {
                    ctx.globalAlpha = (p.life / 22) * pos.scale * 0.4;
                    ctx.save();
                    ctx.translate(pos.x, pos.y);
                    ctx.rotate(p.rotation);
                    const radius = p.radius * pos.scale;
                    const colors = ballSkins[currentSkin].colors;
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius);
                    gradient.addColorStop(0, colors[1] + '80');
                    gradient.addColorStop(0.5, colors[2] + '50');
                    gradient.addColorStop(1, colors[2] + '00');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            });
            ctx.globalAlpha = 1;

            particles.sort((a, b) => b.z - a.z).forEach(p => {
                const pos = get3DPosition(p.x, p.y, p.z);
                if (pos.scale > 0.2) {
                    ctx.globalAlpha = (p.life / 35) * pos.scale;
                    ctx.save();
                    ctx.translate(pos.x, pos.y);
                    ctx.rotate(p.rotation);
                    const size = p.size * pos.scale;
                    ctx.shadowBlur = 12 * pos.scale;
                    ctx.shadowColor = p.color;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-size/2, -size/2, size, size);
                    ctx.shadowBlur = 0;
                    ctx.restore();
                }
            });
            ctx.globalAlpha = 1;

            shineParticles.forEach(p => {
                const pos = get3DPosition(p.x, p.y, p.z);
                if (pos.scale > 0.2) {
                    ctx.globalAlpha = (p.life / 20) * pos.scale;
                    const size = p.size * pos.scale;
                    ctx.fillStyle = '#ffffff';
                    ctx.shadowBlur = 15 * pos.scale;
                    ctx.shadowColor = 'rgba(255,255,255,0.8)';
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
            ctx.globalAlpha = 1;

            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.rotation);
            const pulse = Math.sin(player.pulsePhase) * 4;
            const currentRadius = player.radius + pulse;

            ctx.globalAlpha = 0.25;
            ctx.fillStyle = 'rgba(0,0,0,0.25)';
            ctx.beginPath();
            ctx.ellipse(5, currentRadius + 15, currentRadius * 0.8, currentRadius * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;

            const colors = ballSkins[currentSkin].colors;

            ctx.shadowBlur = 40 + player.glowIntensity * 20;
            ctx.shadowColor = colors[3] + 'B3';

            const outerGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, currentRadius + 15);
            outerGlow.addColorStop(0, colors[1] + '66');
            outerGlow.addColorStop(1, colors[1] + '00');
            ctx.fillStyle = outerGlow;
            ctx.beginPath();
            ctx.arc(0, 0, currentRadius + 15, 0, Math.PI * 2);
            ctx.fill();

            const gradient = ctx.createRadialGradient(-currentRadius * 0.3, -currentRadius * 0.3, 0, 0, 0, currentRadius);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(0.3, colors[1]);
            gradient.addColorStop(0.6, colors[2]);
            gradient.addColorStop(0.8, colors[3]);
            gradient.addColorStop(1, colors[4]);
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(0, 0, currentRadius, 0, Math.PI * 2);
            ctx.fill();

            ctx.shadowBlur = 0;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.arc(0, 0, currentRadius - 9, 0, Math.PI * 2);
            ctx.stroke();

            ctx.fillStyle = '#ffffff';
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(255,255,255,0.9)';
            ctx.beginPath();
            ctx.arc(currentRadius * 0.2, -currentRadius * 0.2, currentRadius / 3.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            for (let i = 0; i < 3; i++) {
                const angle = (player.pulsePhase * 2 + i * Math.PI * 2 / 3);
                const dist = currentRadius * 0.6;
                ctx.globalAlpha = 0.4;
                ctx.fillStyle = colors[0];
                ctx.beginPath();
                ctx.arc(Math.cos(angle) * dist, Math.sin(angle) * dist, 5, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function gameLoop() {
            if (!gameStarted || gameReady) return;
            update();
            draw();
            if (!gameOver) requestAnimationFrame(gameLoop);
        }

        function endGame() {
            gameOver = true;
            gameStarted = false;
            playDeathSound();

            coins += earnedCoins;
            const newTotal = (parseInt(localStorage.getItem('gravityFlipTotalCoins')) || 0) + earnedCoins;
            localStorage.setItem('gravityFlipTotalCoins', newTotal);
            localStorage.setItem('gravityFlipCoins', coins);

            if (distance > bestDistance) {
                bestDistance = distance;
                localStorage.setItem('gravityFlipBest', bestDistance);
            }

            const colors = ballSkins[currentSkin].colors;
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: player.x, y: player.y, z: player.z + (Math.random() - 0.5) * 200,
                    vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20, vz: (Math.random() - 0.5) * 10,
                    life: 60, size: Math.random() * 7 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rotation: Math.random() * Math.PI * 2, rotationSpeed: (Math.random() - 0.5) * 0.3
                });
            }

            for (let i = 0; i < 20; i++) {
                shineParticles.push({
                    x: player.x, y: player.y, z: player.z,
                    angle: Math.random() * Math.PI * 2, speed: Math.random() * 5 + 3,
                    life: 30, size: Math.random() * 4 + 2
                });
            }

            draw();

            const newMilestones = checkMilestones();

            setTimeout(() => {
                document.getElementById('hud').style.display = 'none';
                document.getElementById('difficulty').style.display = 'none';
                document.getElementById('instruction').style.display = 'none';
                document.getElementById('gameOverScreen').style.display = 'flex';
                document.getElementById('finalDistance').textContent = distance + 'm';
                document.getElementById('coinsEarned').textContent = '+' + earnedCoins;
                document.getElementById('totalCoins').textContent = coins;
            }, 400);
        }

        checkMilestones();
        draw();
    </script>
</body>
</html>
